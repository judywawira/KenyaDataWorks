{% extends "base.html" %}

{% block title %}GCap{% endblock %}

{% block sub-head %}
<script type="text/template" id="job-selection-list-template">
    <ul class="job-list">
    </ul>
    <button class="select" id="job-selected">Upload</button>
</script>

<script type="text/template" id="job-template">
    <input type="radio" name="select-job" class="select-job" id="<%= id %>" 
        <% if (selected) { %>
            checked="checked"
        <% } %> 
    />
    <% if (selected) { %>
        <span class="file-selected">
    <% } else { %>
        <span class="file-deselected">
    <% } %>
        <%= name %>, <%= status %>
    </span>
</script>

<script type="text/template" id="job-document-template">
    <p>Upload this document?</p>
    <ul class='sheet-list'>
    </ul>
    <button class="continue" id="select-document">Yes</button>
    <button class="abort" id="abort-document">No</button>
</script>

<script type="text/template" id="job-sheet-image-template">
    <img src="/cap-sheet-image/<%= id %>/" />
</script>

 
<script src="{{STATIC_URL}}captricity_cloud_io/util.js"></script>
<script src="{{STATIC_URL}}captricity_cloud_io/cap.js"></script>

<script>
    window.gdata_upload_url = "{% url captricity_cloud_io.views.queue_for_gdata_upload %}"
    // Initialize the captricity API schema object so that we can use the autogenerated backbone models (courtesy of schema.js hosted at Captricity)
    window.schema = new captricity.APISchema();
    schema.bind('reset', initialize);

    UploadJobListView = JobListView.extend({
        events: {
            'click .select': 'selectJob',
        },

        selectJob: function() {
            window.App.navigate('confirm', true);
        },
    });

    window.DatasetExport = Backbone.Router.extend({
        routes: {
            '': 'home',
            'confirm': 'confirmDoc',
        },

        initialize: function() {
            // We want to only show jobs that is in the completed phase, since those are the only jobs with results
            this.jlView = new UploadJobListView({filter: 'completed'});
            this.dlView = new DocumentListView({});
        },

        home: function() {
            $('#box-browser').empty();
            $('#box-browser').append(this.jlView.render().el);
        },

        confirmDoc: function() {
            $('#box-browser').empty();
            $('#box-browser').append(this.dlView.render().el);
        },
    });

    $(document).ready(function() {
        $.getJSON({% url captricity_cloud_io.views.test_gdata_token %},
            function(response) {
                if (response.status == "failed")
                    window.location.href = {% url captricity_cloud_io.views.gdata_login %};
                else {
                    schema.fetch();
                }
            });
    });

    function initialize() {
        window.selectedJob = null;
        window.App = new DatasetExport();
        Backbone.history.start();
    }
</script>
{% endblock %}

{% block body %}
<div id="box-browser">
</div>
{% endblock %}

