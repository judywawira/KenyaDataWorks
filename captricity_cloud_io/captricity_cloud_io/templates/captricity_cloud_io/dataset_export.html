<html>
<head>
    <meta charset="utf-8">

    <title>GCap</title>

    <script src="{{STATIC_URL}}captricity_cloud_io/libs/jquery-1.8.13/js/jquery-1.6.1.min.js"></script>
    <script src="{{STATIC_URL}}captricity_cloud_io/libs/jquery-1.8.13/js/jquery-ui-1.8.13.custom.min.js"></script>
    <script src="{{STATIC_URL}}captricity_cloud_io/libs/jquery.tmpl.min.js"></script>
    <script type="text/javascript" src="{{STATIC_URL}}captricity_cloud_io/libs/underscore-min.js"></script>

    <script src="{{STATIC_URL}}captricity_cloud_io/libs/underscore.js"></script>
    <script src="{{STATIC_URL}}captricity_cloud_io/plugins.js"></script>
    <script type="text/javascript" src="{{STATIC_URL}}captricity_cloud_io/libs/backbone-min.js"></script>


<style>
</style>

<script type="text/template" id="job-selection-list-template">
    <ul class="job-list">
    </ul>
    <button class="select" id="job-selected">Upload</button>
    <button class="sync" id="job-sync">Sync</button>
</script>

<script type="text/template" id="job-template">
    <input type="radio" name="select-job" class="select-job" id="<%= id %>" 
        <% if (selected) { %>
            checked="checked"
        <% } %> 
    />
    <% if (selected) { %>
        <span class="file-selected">
    <% } else { %>
        <span class="file-deselected">
    <% } %>
        <%= name %>, <%= status %>
    </span>
</script>

<script type="text/template" id="job-document-template">
    <p>Sync this document?</p>
    <ul class='sheet-list'>
    </ul>
    <button class="continue" id="select-document">Yes</button>
    <button class="abort" id="abort-document">No</button>
</script>

<script type="text/template" id="job-sheet-image-template">
    <img src="/cap-sheet-image/<%= id %>/" />
</script>

<script type="text/template" id="gdata-spreadsheet-list-template">
    <ul class="spreadsheet-list">
    </ul>
    <button class="sync" id="job-sync">Sync Job with Google</button>
    <button class="new-sync" id="job-new-sync">Create new spreadsheet</button>
</script>

<script type="text/template" id="gdata-spreadsheet-template">
    <input type="radio" name="select-spreadsheet" class="select-spreadsheet" id="<%= id %>" 
        <% if (selected) { %>
            checked="checked"
        <% } %> 
    />
    <% if (selected) { %>
        <span class="file-selected">
    <% } else { %>
        <span class="file-deselected">
    <% } %>
        <%= title %>
    </span>
</script>

 
<script src="{{STATIC_URL}}captricity_cloud_io/util.js"></script>
<script src="{{STATIC_URL}}captricity_cloud_io/cap.js"></script>
<script src="{{STATIC_URL}}captricity_cloud_io/goog.js"></script>

<script>
    UploadJobListView = JobListView.extend({
        events: {
            'click .select': 'selectJob',
            'click .sync': 'syncJob',
        },

        syncJob: function() {
            window.App.navigate('confirm', true);
        },

        selectJob: function() {
            $.ajax({
                type: 'POST',
                url: {% url captricity_cloud_io.views.queue_for_gdata_upload %},
                dataType: 'json',
                data: { job_id: window.selectedJob.get('id') },
                success: function(response) {
                    if (response.status == 'success') {
                        alert("Successfully initiated download task on Captricity");
                        window.App.navigate('', true);
                    }
                    else {
                        alert("Unsuccessful initiation of download task");
                    }
                },
            });
        },
    });

    window.DatasetExport = Backbone.Router.extend({
        routes: {
            '': 'home',
            'confirm': 'confirmDoc',
            'sync': 'sync',
        },

        initialize: function() {
            this.jlView = new UploadJobListView({});
            this.ssView = new SpreadsheetListView({});
            this.dlView = new DocumentListView({});
        },

        home: function() {
            $('#box-browser').empty();
            $('#box-browser').append(this.jlView.render().el);
        },

        confirmDoc: function() {
            $('#box-browser').empty();
            $('#box-browser').append(this.dlView.render().el);
        },

        sync: function() {
            $('#box-browser').empty();
            $('#box-browser').append(this.ssView.render().el);
        },
    });

    $(document).ready(function() {
        $.getJSON({% url captricity_cloud_io.views.test_gdata_token %},
            function(response) {
                if (response.status == "failed")
                    window.location.href = {% url captricity_cloud_io.views.gdata_login %};
                else {
                    window.spreadsheets = new SpreadsheetCollection();
                    window.spreadsheets.fetch();
                    window.jobs = new JobCollection();
                    window.jobs.fetch({ data: $.param({ status: "completed" }) });
                    window.selectedJob = null;
                    window.selectedSpreadsheet = null;
                    window.App = new DatasetExport();
                    Backbone.history.start();
                }
            });
    });
</script>
</head>

<body>
<div id="box-browser">
</div>
</body>

</html>



